<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>head_title</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="keywords" content="Geoportal, Atlas, GDI, Ort, Geodaten, Geodatenkatalog, POI">
<meta name="description" content="Atlas">
<meta name="robots" content="index,follow">
<meta name="revisit-after" content="10 days">
<!-- meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="expires" content="0"-->
<meta http-equiv="cache-control" content="max-age=3600, must-revalidate">
<meta name="resource-type" content="document">
<meta name="Audience" content="Alle">
<meta name="rating" content="general">
<meta name="objecttype" content="journal">
<meta name="distribution" content="global">
<link rel="shortcut icon" href="images/favicon.ico">

<!-- jQuery -->
<script language="javascript" src="lib/jquery-1.4.2.min.js" type="text/javascript"></script>
<script language="javascript" src="lib/urlEncode.js" type="text/javascript"></script>
<script language="javascript" src="lib/jFav_v1.0.js" type="text/javascript"></script>
<script language="javascript" src="lib/jquery.getUrlParam.js" type="text/javascript"></script>
<script language="javascript" src="lib/jquery-ui-1.8.custom.min.js" type="text/javascript"></script>
<script language="javascript" src="lib/jquery.dd.js" type="text/javascript"></script>
<script language="javascript" src="lib/jquery.layout-1.2.0.js" type="text/javascript"></script>
<script language="javascript" src="lib/jquery.localizer.js" type="text/javascript"></script>
<script language="javascript" src="lib/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>

<!-- OpenLayers -->
<script src="openlayers/full/OpenLayers.js" type="text/javascript"></script>
<script src="openlayers/full/popup.js" type="text/javascript"></script>
<!--script src="openlayers/full/tooltips.js" type="text/javascript"></script-->

<!-- CSS -->
<link rel="stylesheet" type="text/css" href="css/smoothness/jquery-ui-1.8.4.custom.css" />
<!--link rel="stylesheet" type="text/css" href="css/redmond/jquery-ui-1.8.custom.css" /-->
<!--link rel="stylesheet" type="text/css" href="css/ui-lightness2/jquery-ui-1.8.custom.css" /-->
<link rel="stylesheet" type="text/css" href="css/cupertino2/jquery-ui-1.8.custom.css" />
<!--link rel="stylesheet" type="text/css" href="css/pepper-grinder/jquery-ui-1.8.custom.css" /-->
<link rel="stylesheet" type="text/css" href="css/dd.css" />
<link rel="stylesheet" type="text/css" href="css/atlas-mittelsachsen.layout.css" />

<!-- Atlas JavaScript -->
<script src="js/utils.js" type="application/javascript"></script>
<script src="js/atlas.layout.js" type="application/javascript"></script>
<script src="js/inheritance.js" type="application/javascript"></script>
<script src="js/events.js" type="application/javascript"></script>
<script src="js/toolitems.js" type="application/javascript"></script>
<script src="js/topbar.js" type="application/javascript"></script>
<script src="js/transmap.js" type="application/javascript"></script>
<script src="js/measure.js" type="application/javascript"></script>
<script src="js/searchcontext.js" type="application/javascript"></script>

<!-- Local config -->
<script type="text/javascript">

/** The configuration of the search field */
var search_field_config = {
    //autocomplete_url : '../polymap/lka/search',
    autocomplete_url : 'search',
    search_url : 'search',
    base_url : 'index-mittelsachsen.html'
}

/** Array of SearchContext instances. */
var contexts = null;
/** The currently active SearchContext: 0->red, 1->green... */
var result_index = 0;

/** The map and the layers. */
map = null;
var mapCRS = "EPSG:31468";
var dop = null;
var topo_transparent = null;
var border = null;
var measure = null;
var highlightColor = "#f55";
var dialogDiv;
var transmap;


function initLocal() {
    // init I18N
    jQuery.i18n.properties({
        name: 'messages', 
        path: 'bundle/', 
        mode: 'map', 
        //language: 'cz_CZ',
    });

    // language map
    transmap = new TransMap();
    
    // Topbar
    new Topbar( $('#topbar') )
        .addLeft( new LinkToolItem( "tb_1", $.i18n.prop( "project_title" ), 
                "tooltip", $.i18n.prop( "project_link" ) ) )
        .addLeft( new LinkToolItem( "tb_2", "Projekt", "tooltip", "http://google.de" ) )
        .addLeft( new LinkToolItem( "tb_3", "Geo-Katalog", "tooltip", "http://google.de" ) )
        .create();
    
    // Toolbar
    new Toolbar( $('#toolbar2') )
        .addLeft( new ToggleLayerItem( "tb_dop", $.i18n.prop( "tb_dop_label" ), 
                $.i18n.prop( "tb_dop_label" ), $.i18n.prop( "tb_dop_icon" ), map, "DOP" ) )
        .addRight( new ToggleMeasureItem( "tb_measure", measure ) )
        .addRight( new LinkItem( "tb_link" ) )
        .addRight( new KmlItem( "tb_kml" ) )
        .addRight( new GeoRssItem( "tb_georss" ) )
        .addRight( new BookmarkItem( "tb_bookmark" ) )
        .create();
    
    dialogDiv = $('#dialog');
    
    // search contexts
    contexts = [
        new SearchContext( map, 0, "images/marker_red.png", $("#result_body0"), '#ff0000' ),
        new SearchContext( map, 1, "images/marker_green.png", $("#result_body1"), '#00ff00' ),
        new SearchContext( map, 2, "images/marker_yellow.png", $("#result_body2"), '#00ffff' ),
        new SearchContext( map, 3, "images/marker_blue.png", $("#result_body3"), '#0000ff' ) 
    ];
    for (var i=0; i < contexts.length; i++) {
        contexts[i].attribution = 'Daten von <a href=\"http://polymap.de\">Test</a>';
        contexts[i].mapCRS = mapCRS;

        // translate search
        contexts[i].createSearchUrl = function( searchStr ) {
            return search_field_config.search_url + 
                    "?search=" + transmap.enhanceSearch( searchStr ) + 
                    "&outputType=JSON&srs=" + this.map.getProjection();
        }
        // translate result
        contexts[i].resultFieldEnhancers.push( function( str ) {
            return transmap.enhanceResult( str );
        });
    };
    
    // search context tabs
    var $tabs = $('#tabs').tabs(); // first tab selected
    $('#tabs').bind( 'tabsselect', function( event, ui ) {
        //ui.tab     // anchor element of the selected (clicked) tab
        //ui.panel   // element, that contains the selected/clicked tab contents
        
        contexts[result_index].searchStr = $('#search_field').val();
        contexts[result_index].deactivate();     
        
        result_index = ui.index;   // zero-based index of the selected (clicked) tab
        contexts[result_index].activate();
        updateLinks();     
    });

    // search field
    $('#search_field').autocomplete({ 
        source: search_field_config.autocomplete_url,
        zIndex: 1000,
        delay: 500
        }
    );
    $('#search_field').keypress( function( event ) {
        if (event.keyCode == 13) {
            search();
            $('#search_field').autocomplete( "close" );
        }
    } );
    $('#search_field').focus();
    
    updateLinks();

    // localize HTML
    $(function() {
        $('html').localize();
    });
}

function initMap() {
    // DOP *********
    dop = new OpenLayers.Layer.WMS( "DOP", 
        "polymap/services/Atlas-Hintergrund",
        { layers : 'DOP-RGS',
          format: "image/jpeg" },
        {
          transparent: true,
          isBaseLayer: false,
          transitionEffect: 'resize'
    });
    dop.setVisibility( false );
    dop.buffer = 0;
    dop.attribution = '<a href="http://www.landesvermessung.sachsen.de/inhalt/geo/basis/basis_dienste.html#geosn">GeoSN</a>';

    // Mapnik **********
    var fiveDays = 5*24*60*60;
    mapnik = new OpenLayers.Layer.OSM( "OSM Mapnik", 
        "osmcache/${z}/${x}/${y}.png?targetBaseURL=http://tile.openstreetmap.org&expires=" + fiveDays, {  // "http://tile.openstreetmap.org/${z}/${x}/${y}.png", {
        transitionEffect: 'resize',
        isBaseLayer: true
    });
    // override default EPSG code
    aliasproj = new OpenLayers.Projection( "EPSG:3857" );
    mapnik.projection = aliasproj;
    mapnik.buffer = 0;
    
    // Mapnik transparent **********
    var fiveDays = 5*24*60*60;
    mapnikTransparent = new OpenLayers.Layer.OSM( "OSM Mapnik (transparent)",
        "osmcache/${z}/${x}/${y}.png?transparent=F2EFEA&targetBaseURL=http://tile.openstreetmap.org&expires=" + fiveDays, {
        transitionEffect: 'resize',
        isBaseLayer: false
    });
    mapnikTransparent.setVisibility( false );
    mapnikTransparent.projection = aliasproj;
    mapnikTransparent.buffer = 0;

    // Border *********
    border = new OpenLayers.Layer.WMS( "Kreisgrenze",
        "../services/Atlas-Hintergrund",
        { layers : 'Kreisgrenze2',
          //projection: new OpenLayers.Projection( "EPSG:25833" ),
          transparent: true,
          isBaseLayer: false
    });
    border.setVisibility( true );
    border.buffer = 0;
    border.attribution = 'powered by <b><a href="http://polymap.org/polymap3">POLYMAP3</a></b>';

    // Hillshade **********
    hillshade = new OpenLayers.Layer.OSM( "Hillshade", 
        "osmcache/${z}/${x}/${y}.png?targetBaseURL=http://toolserver.org/~cmarqu/hill&expires=" + fiveDays, {  // "http://toolserver.org/~cmarqu/hill/${z}/${x}/${y}.png", {
        isBaseLayer: false,
        visibility: false,
        attribution: '<a href="http://www.nasa.gov/">NASA SRTM</a>',
        buffer: 0
    });
    hillshade.projection = aliasproj;
    
    var extent = new OpenLayers.Bounds( 11.50, 50.00, 15.25, 52.40 )
        .transform( 
            new OpenLayers.Projection("EPSG:4326"),
            new OpenLayers.Projection("EPSG:900913"));

    // Map ************
    
    // set transformation functions from/to alias projection
    OpenLayers.Projection.addTransform( "EPSG:4326", "EPSG:3857", OpenLayers.Layer.SphericalMercator.projectForward );
    OpenLayers.Projection.addTransform( "EPSG:3857", "EPSG:4326", OpenLayers.Layer.SphericalMercator.projectInverse );

    // avoid pink tiles
    OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
    OpenLayers.Util.onImageLoadErrorColor = "transparent";
    OpenLayers.Util.MISSING_TILE_URL = "http://openstreetmap.org/openlayers/img/404.png";

    var mapOptions = {
        div: "map",
        projection: new OpenLayers.Projection( "EPSG:900913" ),
        displayProjection: new OpenLayers.Projection( "EPSG:4326" ),
        maxExtent: extent,
        restrictedExtent: extent
    };
    map = new OpenLayers.Map( mapOptions );

    map.events.register( 'moveend', map, function (e) {
        var mapScale = this.getScale();
        //alert( mapScale );
        if (mapScale < 150000) {
            border.setVisibility(false);
        } else {
            border.setVisibility(true);
        }
    });

    map.addLayer( mapnik );
    map.addLayer( dop );
    map.addLayer( mapnikTransparent );
    map.addLayer( hillshade );
    map.addLayer( border );
    map.zoomToMaxExtent();

    map.setCenter( new OpenLayers.LonLat( 13.50, 51.00 )
            .transform(
                new OpenLayers.Projection( "EPSG:4326" ), // transform from WGS 1984
                new OpenLayers.Projection( "EPSG:900913" ) // to Spherical Mercator Projection
            ), 9 // Zoom level
    );

    // Controls *********
    var overview = new OpenLayers.Control.OverviewMap( {
        autoActivate: true, 
        size: new OpenLayers.Size( 210, 170 ),
        mapOptions: mapOptions
    });
    map.addControl( overview );
    //overview.activate();
    //overview.maximizeControl();

    map.addControl( new OpenLayers.Control.PanZoomBar() );
    var scaleLine = new OpenLayers.Control.ScaleLine();
    scaleLine.geodesic = true;
    map.addControl( scaleLine );
    map.addControl( new OpenLayers.Control.MousePosition() );
//    map.addControl( new OpenLayers.Control.KeyboardDefaults() );
//    map.addControl( new OpenLayers.Control.LayerSwitcher() );
    //map.addControl( new OpenLayers.Control.Attribution() );
    //map.addControl( new OpenLayers.Control.Navigation() );

    // init measure
    measure = new MeasureMode( map, $("#measure_link") );
}


/**
 * 
 */
function search() {
    var searchStr = $("#search_field").val();
    contexts[result_index].search( searchStr );
    updateLinks();
    
    var ev = jQuery.Event( "searchCompleted" ); 
    ev.searchStr = searchStr;
    ev.searchURL = search_field_config.search_url + "?search=" + searchStr;
    EventManager.fire( ev );
};


function updateLinks() {
    var searchStr = contexts[result_index].searchStr;
    
    // ?search=XY&search2=AB
    var allSearchParams = null;
    for (i=0; i<contexts.length; i++) {
        var context = contexts[i];
        if (context.searchStr != null && context.searchStr.length > 0) {
            allSearchParams = allSearchParams == null 
                    ? "?" : allSearchParams + "&";
            allSearchParams += "search" + (i+1) + "=" + context.searchStr;
        }
    }    
    var pageURL = location.protocol + "//" 
            + location.host + location.pathname + allSearchParams;
    
    if (searchStr.length > 0) {
        $("#bookmark_link").attr( "onClick", "createBookmark('Mittelsachsen Atlas','" + pageURL + "', '')" );
    } else {
        $("#bookmark_link").attr( "onClick", "alert('Dieser Link ermöglicht das Setzen eines Lesezeichens für eine Suchanfrage. Geben Sie zuerst eine Suchabfrage ein.')" );
    }

    if (searchStr.length > 0) {
        $("#link_input").attr( "value", pageURL );
        $("#html_link_input").attr( "value", "<iframe width=\"425\" height=\"350\" frameborder=\"0\" scrolling=\"no\" marginheight=\"0\" marginwidth=\"0\" src=\"" + pageURL + "\"></iframe>" );
        $("#link_link").attr( "onClick", "showLinkDialog($('#link_dialog'))" );
    } else {
        $("#link_link").attr( "onClick", "alert(\"Dieser Link ermöglicht das Versenden und Speichern von Suchanfragen. Geben Sie zuerst eine Suchabfrage ein.\")" );
    }
};
</script>
</head>

<!-- ******************************************************
  - HTML
  -->
<body onload="initMap(); initLocal(); initUrlParams(); init_layout();">        

<!-- Layout North -->
<!--div class="ui-layout-north" onmouseover="myLayout.allowOverflow('north')" onmouseout="myLayout.resetOverflow(this)"-->
<div class="ui-layout-north" style="padding:0px; overflow:visible; overflow-x:auto; overflow-y:hidden;">
    <!-- Topbar -->
    <div id="topbar">
    </div>

    <!-- Logo -->
    <div style="position:absolute; padding:5pt; margin:0pt;">
        <a title="logo_title" href="logo_link"> 
        <img style= border:none; src="logo_img" id="logo" alt="logo_img_alt" width="200" height="74"/></a>
    </div>
    
    <!-- Search Form -->
    <div style="position:absolute; left:300px; padding:20px 0px 0px 0px; margin:0px;">
        <img style="margin: 1px 0px 0px; padding: 0px; position: absolute; left: -38px; top: 20px;" src="images/marker_red.png" id="search_img">
        
        <input title="Sucheingabe" id="search_field"  name="q" size="40" maxlength="150" init="true" class="lst ui-autocomplete-input ui-widget" 
        style="  padding: 1px; height: 32px; width: 400px; position: absolute;top: 20px; left: 0px;"/>
        
        <input type="submit" value="Suchen" title="Suchen" class="ui-widget-content ui-widget-header ui-widget" 
        style=" padding: 0px; height: 32px; width: 120px;border-top: 1px solid #cccccc;border-left: 1px solid #cccccc;border-right: 1px solid #999999;
        border-bottom: 1px solid #999999;  margin: 0px;  position: absolute;top: 20px;left: 399px;" onclick="search();"/>

        <!-- input type="text" id="search_field" size="40" style="zIndex:10000;"/-->
        <!--input type="submit" value="Suchen" onclick="search();"-->
        <!-- div id="text_under_search">Entdecke Orte in Mittelsachsen.</div-->
    </div>
</div>

<!-- Layout East -->
<div id="tabs" class="ui-layout-east" style="visibility:hidden;">
    <!--div id="tabs" style="height: 100%;"-->
        <ul style="border-top:none; border-right:none; border-left:none;">
            <li><a href="#result_body0" style="border: none;"><img
                src="images/marker_red.png" width="24" height="14" style="border: none;" /></a></li>
            <li><a href="#result_body1"><img src="images/marker_green.png"
                width="24" height="14" style="border: none;" /></a></li>
            <li><a href="#result_body2"><img src="images/marker_yellow.png"
                width="24" height="14" style="border: none;" /></a></li>
            <li><a href="#result_body3"><img src="images/marker_blue.png"
                width="24" height="14" style="border: none;" /></a></li>
        </ul>
        <div id="result_body0" class="ui-layout-content">
            <p>An dieser Stelle erscheinen die Ergebnisse der Suchkategorie "rot".</p>
            <p>
            Die Ergebnisse weiterer Suchanfragen k&ouml;nnen den anders farbigen Kategorien (gr&uuml;n, gelb und blau) zugeordnet werden. So k&ouml;nnen Sie ein individuelles Themenprofil f&uuml;r sich erstellen. 
            </p>
        </div>
        <div id="result_body1" class="ui-layout-content">
            <p>Keine Suche f&uuml;r gr&uuml;n -&gt; keine Treffer</p>
        </div>
        <div id="result_body2" class="ui-layout-content">
            <p>Keine Suche f&uuml;r gelb -&gt; keine Treffer</p>
        </div>
        <div id="result_body3" class="ui-layout-content">
            <p>Keine Suche f&uuml;r blau -&gt; keine Treffer</p>
        </div>
</div>

<!-- Layout Center -->
<!-- overflow-xxx is for IE to hide vertical scrollbar -->
<div class="ui-layout-center" style="visibility:hidden; padding:0px; overflow:visible; overflow-x:auto; overflow-y:hidden;">
    
    <div id="toolbar2"></div>
    
    <div id="map" style="zIndex:9000; background:#98B5D1"></div>
</div>

<!-- This div is used as the content of the dialog boxes for help, contact, etc. -->
<div id="dialog"></div>

</body>
</html>
